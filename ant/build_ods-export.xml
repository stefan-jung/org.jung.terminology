<?xml version="1.0" encoding="UTF-8"?>
<!--
    This Apache Ant script operates on the <termmap>.
    It iterates over all <termentry> topics and generates
    a list of terms in all languages or in a specific language.
    This might be useful, if you'd like to provide a full list
    of terms in a certain languages for a translator to review.
    
    Afterwards, we create an Excel .xlsx file from our XML data.
    An Excel .xlsx file is technically just a ZIP file with some 
    XML files and other data. Therefore, we need an Apache Ant
    script to do this and cannot implement this in pure XSLT.
-->
<project basedir="." name="Excel Export" default="ods-export" xmlns:if="ant:if" xmlns:unless="ant:unless">


    <!-- 
        ================================================================================
        Includes
        ================================================================================ 
    -->
    <include file="build_saxon.xml"/>
    

    <!-- 
        ================================================================================
        Imports
        ================================================================================ 
    -->
    <import file="build_temp-dir.xml"/>
    
    
    <!-- 
        ================================================================================
        Properties
        ================================================================================ 
    -->
    <property environment="env"/>
    <property name="debugging.mode" value="true"/>
    <condition property="dbg">
        <equals arg1="${debugging.mode}" arg2="true"/>
    </condition>
    
    
    <!-- 
        ================================================================================
        Targets
        ================================================================================ 
    -->
    <target name="ods-export" depends="-temp.dir">
        <fail unless="termmap" message="The mandatory property 'termmap' is not set."/>
        <fail unless="language" message="The mandatory property 'language' is not set."/>
        
        <!-- Subdirectory in the  temporary directory of the terminology plugin. -->
        <property name="ods-export.temp.dir" value="${jung.terminology.temp.dir}${file.separator}ods-export"/>
        <echo if:true="${debugging.mode}" message="+ [DEBUG] ods-export.temp.dir = ${ods-export.temp.dir}"/>
        
        <!-- Delete the directory, if it exists. -->
        <delete dir="${ods-export.temp.dir}" failonerror="false"/>
        
        <!-- Create a new temporary directory. -->
        <mkdir dir="${ods-export.temp.dir}"/>
        
        <!-- In this directory we extract the ODS template and assemble the content of the ODS file. -->
        <property name="ods.dir" value="${ods-export.temp.dir}${file.separator}ods"/>
        <echo if:true="${debugging.mode}" message="+ [DEBUG] ods.dir = ${ods.dir}"/>
        <mkdir dir="${ods.dir}"/>
        
        <!-- Extract the ODS template -->
        <!--<unzip src="../templates/export.ods" dest="${ods.dir}"/>
        <echo if:true="${debugging.mode}" message="+ [DEBUG] Unzip ODS template in '${ods.dir}'"/>-->
        
        <xslt 
            in="${termmap}"
            out="${ods.dir}${file.separator}content.xml"
            style="../xsl/ods-export/ods-export.xsl">
            <factory name="net.sf.saxon.TransformerFactoryImpl"/>
            <classpath refid="saxon"/>
            <param name="language" expression="${language}"/>
        </xslt>
        <echo if:true="${debugging.mode}" message="+ [DEBUG] Transform terminology to '${ods-export.temp.dir}${file.separator}ods.xml'"/>
        
        <!-- Copy ODS XML to ODS directory -->
        <!--<copy file="${ods-export.temp.dir}${file.separator}ods.xml" tofile="'${ods.dir}${file.separator}content.xml"/>-->
        
        <!-- Create a valid ODS file from the ODS directory -->
        <!-- We must not compress the file -->
        <copy file="../templates/export.ods" tofile="${ods-export.temp.dir}${file.separator}export.ods"/>
        
        <zip destfile="${ods-export.temp.dir}${file.separator}export.ods" basedir="${ods.dir}" compress="false" update="true"/>
        <echo message="Created ODS file '${ods-export.temp.dir}${file.separator}export.ods'"/>
        
        <!-- Open file -->
        <condition property="linux">
            <os family="unix"/>
        </condition>
        <exec if:true="${linux}" executable="xdg-open">
            <arg value="${ods-export.temp.dir}${file.separator}export.ods"/>
        </exec>
        <condition property="windows">
            <os family="windows"/>
        </condition>
        <exec if:true="${windows}" executable="cmd.exe">
            <arg value="/c" />
            <arg value="start" />
            <arg value="" /> <!-- Empty argument for a new command window -->
            <!--<arg value="path\\to\\your\\file"/>-->
            <arg value="${ods-export.temp.dir}${file.separator}export.ods"/>
        </exec>
        
    </target>

</project>