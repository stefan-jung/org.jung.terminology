<?xml version="1.0" encoding="UTF-8"?>
<!--
    This is the build script of the term harvester.
    It is meant to be called by an Oxygen transformation scenario.
    It takes a series of properties as input, like a directory with either XLIFF or TMX
    files to extract terms from, the expected output format, and so forth.
    
    This script iterates over the comma-separated list of terms to extract.
    It does intentionally not iterate over the TMX/XLIFF files.
    This is done in XSLT with a collection().
-->
<project default="termharvester" xmlns:if="ant:if" xmlns:unless="ant:unless" basedir=".">
    
    <!-- Properties -->
    <property environment="env"/>
    <property name="debugging.mode" value="true"/>
    
    <condition property="dbg">
        <equals arg1="${debugging.mode}" arg2="true"/>
    </condition>
    
    <!-- Includes -->
    <include file="build_antcontrib.xml"/>
    <include file="build_graalvm.xml"/>
    <include file="build_groovy.xml"/>
    <include file="build_saxon.xml"/>
    
    <!-- Imports -->
    <import file="build_substring-before.xml"/>
    <import file="build_desktop-dir.xml"/>
    <import file="build_temp-dir.xml"/>
    
    <!-- Create the output directory if it doesn't exist -->
    <target name="-prepare">
        <fail message="The required property &quot;search.string&quot; is not set.">
            <condition>
                <not>
                    <isset property="search.string"/>
                </not>
            </condition>
        </fail>
        <fail message="The required property &quot;output.type&quot; is not set.">
            <condition>
                <not>
                    <isset property="output.type"/>
                </not>
            </condition>
        </fail>
        <echo>debugging.mode = "${debugging.mode}"</echo>
    </target>
    
    <target name="-termharvester.dirs">
        <mkdir dir="${tmx-xliff.dir}"/>
        <mkdir dir="${terms.dir}"/>
    </target>
    
    <target name="termharvester" depends="-prepare, -temp.dir, -desktop.dir, -termharvester.dirs">
        
        <!-- To make this work, we need -Djava.awt.headless=false as JVM argument. -->
        <!--<groovy>
            import javax.swing.JOptionPane;
            def tmxXliffDir = project.getProperty("tmx-xliff.dir");
            def title = "Term Harvester";
            def message = "The Term Harvester is looking for XLIFF (.xlf, .xliff) and TMX (.tmx) files in the directory:\n\n" + tmxXliffDir;
            JOptionPane.showMessageDialog(null, message, title, JOptionPane.INFORMATION_MESSAGE);
        </groovy>-->
        
        <echo>tmx-xliff.dir = ${tmx-xliff.dir}</echo>
        <pathconvert property="tmx-xliff.dir.absolute.path">
            <path path="${tmx-xliff.dir}"/>
            <mapper type="glob" from="*" to="*"/>
        </pathconvert>
        <echo if:set="dbg">tmx-xliff.dir.absolute.path = ${tmx-xliff.dir.absolute.path}</echo>
        
        <resourcecount property="xlf.count">
            <fileset dir="${tmx-xliff.dir}">
                <include name="*.xlf"/>
                <include name="*.xliff"/>
            </fileset>
        </resourcecount>
        <echo>Found "${xlf.count}" XLIFF (.xlf, .xliff) file(s) in directory "${tmx-xliff.dir}"</echo>
        
        <resourcecount property="tmx.count">
            <fileset dir="${tmx-xliff.dir}">
                <include name="*.tmx"/>
            </fileset>
        </resourcecount>
        <echo>Found "${tmx.count}" TMX (.tmx) file(s) in directory "${tmx-xliff.dir}"</echo>
        
        <fail message="Did not find TMX or XLIFF files in ${tmx-xliff.dir}">
            <condition>
                <and>
                    <equals arg1="${tmx.count}" arg2="0"/>
                    <equals arg1="${xlf.count}" arg2="0"/>
                </and>
            </condition>
        </fail>
        
        <property name="output.file" value="${jung.terminology.temp.dir}${file.separator}termharvester.txt"/>
        <delete file="${output.file}" failonerror="false"/>
        <delete file="${output.file}.temp" failonerror="false"/>
        
        <for list="${search.string}" delimiter="," param="term" trim="true">
            <sequential>
                <antcall target="-extract-term">
                    <param name="term" value="@{term}"/>
                </antcall>
            </sequential>
        </for>
    </target>
    
    <target name="-extract-term">
        <echo>Extracting term "${term}"</echo>
        
        <echo>tmx-xliff.dir = "${tmx-xliff.dir}"</echo>
        <echo>source.language = "${source.language}"</echo>
        <echo>debugging.mode = "${debugging.mode}"</echo>
        <echo>output.type = "${output.type}"</echo>
        
        <echo file="${terms.dir}${file.separator}dummy-input.xml" append="false" force="true">&lt;dummy/></echo>
        <xslt 
            style="../xsl/termharvester/termharvester.xsl"
            in="${terms.dir}${file.separator}dummy-input.xml"
            out="${terms.dir}${file.separator}dummy-output.xml"
            failonerror="true"
            failontransformationerror="true">
            <factory name="net.sf.saxon.TransformerFactoryImpl"/>
            <classpath refid="saxon"/>
            <param name="term" expression="${term}"/>
            <param name="tmx-xliff.dir" expression="${tmx-xliff.dir.url}"/>
            <param name="source.language" expression="${source.language}"/>
            <param name="debugging.mode" expression="${debugging.mode}"/>
            <param name="output.type" expression="${output.type}"/>
        </xslt>
        <delete file="${terms.dir}${file.separator}dummy-input.xml" failonerror="false" quiet="true" verbose="false"/>
        <delete file="${terms.dir}${file.separator}dummy-output.xml" failonerror="false" quiet="true" verbose="false"/>
    </target>
    
    <target name="-gather-main-ids" depends="-temp.dir">
        <echo>Gather main IDs</echo>
        <property name="output.file" value="${jung.terminology.temp.dir}${file.separator}main-terms.txt"/>
        <xslt 
            style="../xsl/termharvester/extract-main-terms.xsl"
            in="${termmap}"
            out="${output.file}"
            failonerror="true"
            failontransformationerror="true">
            <factory name="net.sf.saxon.TransformerFactoryImpl"/>
            <classpath refid="saxon"/>
            <param name="language" expression="${language}"/>
        </xslt>
        <!-- Load ${terms} property, which contains a comma-separated list of main terms --> 
        <loadproperties srcfile="${output.file}"/>
    </target>
    
    <target name="-harvester-properties">
        <property name="output.type" value="termentry"/>
        <property name="search.string" value="${terms}"/>
        <property name="source.language" value="${language}"/>
        <dirname property="termmap.dir" file="${termmap}"/>
        <property name="topics.dir" value="${termmap.dir}${file.separator}topics"/>
        <property name="tmx-xliff.dir" value="${desktop.dir}${file.separator}termharvester${file.separator}tmx-xliff"/>
        <makeurl file="${tmx-xliff.dir}" property="tmx-xliff.dir.url"/>
        <property name="terms.dir" value="${desktop.dir}${file.separator}termharvester${file.separator}terms"/>
        
        <echo>output.type = "${output.type}"</echo>
        <echo>search.string = "${search.string}"</echo>
        <echo>source.language = "${source.language}"</echo>
        <echo>termmap = "${termmap}"</echo>
        <echo>termmap.dir = "${termmap.dir}"</echo>
        <echo>topics.dir = "${topics.dir}"</echo>
        <echo>tmx-xliff.dir = "${tmx-xliff.dir}"</echo>
        <echo>tmx-xliff.dir.url = "${tmx-xliff.dir.url}"</echo>
    </target>
    
    <target name="-harvest-and-integrate">
        <for param="file">
            <path>
                <fileset dir="${topics.dir}">
                    <include name="**/TRM_*.dita"/>
                </fileset>
            </path>
            <sequential>
                
                <!-- Set timer -->
                <script language="javascript" classpathref="graal">
                    project.setProperty('harvestTermTimerStart', new Date().getTime());
                </script>
                
                <echo/>
                <echo>********************************************************************************</echo>
                <echo/>
                <var name="topic.basename" unset="true"/>
                <basename property="topic.basename" file="@{file}"/>
                
                <!-- Gather main term -->
                <echo>Determine main term from "@{file}"</echo>
                <xslt style="../xsl/termharvester/main-term.xsl"
                    in="@{file}"
                    out="${jung.terminology.temp.dir}${file.separator}main-term.properties"
                    force="true"
                    failOnError="true">
                    <factory name="net.sf.saxon.TransformerFactoryImpl"/>
                    <classpath refid="saxon"/>
                    <param name="source.language" expression="en-US"/>
                </xslt>
                <loadproperties srcfile="${jung.terminology.temp.dir}${file.separator}main-term.properties"/>
                
                <echo/>
                <echo>   ${main.term}</echo>
                <echo/>
                <xslt style="../xsl/termharvester/harvest-and-integrate.xsl"
                    in="@{file}"
                    out="${jung.terminology.temp.dir}${file.separator}${topic.basename}"
                    force="true"
                    failOnError="true">
                    <factory name="net.sf.saxon.TransformerFactoryImpl"/>
                    <classpath refid="saxon"/>
                    <param name="debugging" expression="${dbg}"/>
                    <param name="main.term" expression="${main.term}"/>
                    <param name="tmx-xliff.dir" expression="${tmx-xliff.dir.url}"/>
                    <param name="source.language" expression="${source.language}"/>
                    <param name="topics.dir" expression="${topics.dir}"/>
                    <param name="termharvested.file" expression="${terms.dir}${file.separator}${topic.basename}"/>
                </xslt>
                <!-- Overwrite the original file. -->
                <move file="${jung.terminology.temp.dir}${file.separator}${topic.basename}" tofile="@{file}" overwrite="true"/>
                
                <script language="javascript" classpathref="graal">
                    project.setProperty('harvestTermTimer', (new Date().getTime() - harvestTermTimerStart) / 1000)
                </script>
                <echo/>
                <echo>Harvested "${main.term}" terms in ${harvestTermTimer} seconds</echo>
                
                <!-- Unset the main.term and timer --> 
                <var name="main.term" unset="true"/>
                <var name="harvestTermTimerStart" unset="true"/>
                <var name="harvestTermTimer" unset="true"/>
            </sequential>
        </for>
    </target>
    
    <target name="harvest-terms-and-update-topics" depends="
        -gather-main-ids,
        -harvester-properties,
        -harvest-and-integrate">
    </target>

</project>